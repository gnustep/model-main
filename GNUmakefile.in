#  Top level makefile for GNUstep nib2gmodel Package
#
#  Copyright (C) 1997 Free Software Foundation, Inc.
#
#  Author: Adam Fedor <fedor@gnu.org>
#
#  This file is part of GNUstep.
#
#  This library is free software; you can redistribute it and/or
#  modify it under the terms of the GNU General Public License
#  as published by the Free Software Foundation; either version 2
#  of the License, or (at your option) any later version.
#   
#  You should have received a copy of the GNU General Public
#  License along with this library; see the file COPYING.LIB.
#  If not, write to the Free Software Foundation,
#  59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.

#  It would be nice to use the GNUstep Makefile package here, but technically
#  speaking, it hasn't been made yet.

prefix = @prefix@
install_prefix = $(prefix)
exec_prefix = @exec_prefix@
bindir=@bindir@
program_suffix = @EXEEXT@
LN_S=@LN_S@

INSTALL         = @INSTALL@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_DATA    = @INSTALL_DATA@
TAR             = tar
MKDIRS          = $(GNUSTEP_BUILD_ROOT)/Makefiles/mkinstalldirs

GNUSTEP_TARGET_CPU := @target_cpu@
GNUSTEP_TARGET_OS := @target_os@
GNUSTEP_LIB_COMBO := @ac_cv_library_combo@

GNUSTEP_TARGET_CPU := $(shell ./make/clean_cpu.sh $(GNUSTEP_TARGET_CPU))
GNUSTEP_TARGET_OS := $(shell ./make/clean_os.sh $(GNUSTEP_TARGET_OS))
GNUSTEP_OBJ_DIR=obj

PACKAGE_NAME = nib2gmodel
TOPLEV = @TOPLEV@
MAKEDFLAGS = \
      shared=$(SHARED_FLAG) \
      'GNUSTEP_SYSTEM_ROOT=$(GNUSTEP_BUILD_ROOT)' \
      'GNUSTEP_TARGET_CPU=$(GNUSTEP_TARGET_CPU)' \
      'GNUSTEP_TARGET_OS=$(GNUSTEP_TARGET_OS)' \
      'BUILD_NIB2GMODEL=yes'

ifeq ($(GNUSTEP_SYSTEM_ROOT),)
  SHARED_FLAG=no
  GNUSTEP_BUILD_ROOT = $(TOPLEV)/$(prefix)/System
else
  SHARED_FLAG=yes
  GNUSTEP_BUILD_ROOT = $(GNUSTEP_SYSTEM_ROOT)
endif
export GNUSTEP_BUILD_ROOT

include ./Version

#
# The list of subproject directories
#
SUBPROJECTS = gui/Model

#
# For making snapshots and releases
#
SNAPSHOT_TAG = nibsnap-`date +%y%m%d`
RELEASE_TAG = nib2gmod-`echo $(VERSION) | tr . _`

all: make-make make-temp-install header-links subproj-all

make-make:
	$(MAKE) -C make

MAKE_INSTALL_DEPENDENCIES = GNUstep.sh config.h config.make GNUmakefile
make-temp-install: Makefiles/GNUstep.sh
Makefiles/GNUstep.sh: $(foreach f, $(MAKE_INSTALL_DEPENDENCIES), make/$(f))
	$(MAKE) -C make special_prefix=.. install

install: FORCE
	-$(MKDIRS) $(bindir)
	$(INSTALL_PROGRAM) -m 0755 $(SUBPROJECTS)/$(GNUSTEP_OBJ_DIR)/nib2gmodel$(program_suffix) $(bindir)

subproj-clean subproj-distclean subproj-check::
	@GNUSTEP_SYSTEM_ROOT=$(GNUSTEP_BUILD_ROOT); \
	export GNUSTEP_SYSTEM_ROOT; \
	. $(GNUSTEP_BUILD_ROOT)/Makefiles/GNUstep.sh;

uninstall: FORCE
	rm -f $(bindir)/nib2gmodel$(program_suffix)

check: subproj-check

clean-top:
	rm -f *~

clean: make-temp-install subproj-clean clean-top

distclean-top: clean-top
	rm -f GNUmakefile
	rm -rf Makefiles Tools share
	rm -f config.cache config.log config.status

distclean: make-temp-install subproj-distclean distclean-top

FORCE:

# Some subprojects need to be configured after Makefiles have been installed
late-config:

$(SUBPROJECT)-late-config:  make-temp-install $(SUBPROJECT)/config.status
$(SUBPROJECT)/config.status: config.status config.cache
	@GNUSTEP_SYSTEM_ROOT=$(GNUSTEP_BUILD_ROOT); \
	export GNUSTEP_SYSTEM_ROOT; \
	. $(GNUSTEP_BUILD_ROOT)/Makefiles/GNUstep.sh; \
	echo Configuring in $(SUBPROJECT)...; \
	cd $(SUBPROJECT) && ./configure --prefix=$(install_prefix) \
		--cache-file=../config.cache \
		--program-suffix=$(program_suffix)

subproj-all:
	touch gui/gui.make
	@target=`echo $@ | sed 's/subproj-//'`; \
	for f in $(SUBPROJECTS); do \
	  echo Making $$target in $$f...; \
	  if $(MAKE) -C $$f ${MAKEDFLAGS} $$target; then \
	    :; else exit $$?; \
	  fi; \
	done

subproj-install:
	@target=`echo $@ | sed 's/subproj-//'`; \
	for f in make $(SUBPROJECTS); do \
	  echo Making $$target in $$f...; \
	  if $(MAKE) -C $$f ${MAKEDFLAGS} $$target; then \
	    :; else exit $$?; \
	  fi; \
	done

subproj-clean subproj-distclean subproj-check::
	@target=`echo $@ | sed 's/subproj-//'`; \
	for f in $(SUBPROJECTS) make; do \
	  echo Making $$target in $$f...; \
	  if $(MAKE) -C $$f ${MAKEDFLAGS} $$target; then \
	    :; else exit $$?; \
	  fi; \
	done

subproj-uninstall::
	@target=`echo $@ | sed 's/subproj-//'`; \
	for f in $(SUBPROJECTS) make; do \
	  echo Making $$target in $$f...;\
	  if $(MAKE) -C $$f ${MAKEDFLAGS} $$target; then \
	    :; else exit $$?; \
	  fi; \
	done

header-links:
	cd gui; \
	rm -rf Version; \
	$(LN_S) ../Version; 

configure: configure.in
	autoconf

# Regenerate automatically generated files
regenerate: stamp-regenerate

stamp-regenerate: ChangeLog configure
	$(MAKE) -C Documentation $(MAKEDEFINES) regenerate
	touch stamp-regenerate

dist: 
	@echo Making $(PACKAGE_NAME) release $(VERSION)
	cvs -z3 export -r $(RELEASE_TAG) $(PACKAGE_NAME)
	mv $(PACKAGE_NAME) $(PACKAGE_NAME)-$(VERSION)
	tar --gzip -chvf $(PACKAGE_NAME)-$(VERSION).tar.gz \
		$(PACKAGE_NAME)-$(VERSION)
	rm -rf $(PACKAGE_NAME)-$(VERSION)

snapshot-rtag:
	@echo Tagging nib2gmodel for snapshot $(SNAPSHOT_TAG)
	cvs rtag -l $(SNAPSHOT_TAG) $(PACKAGE_NAME)

dist-rtag:
	@echo Tagging nib2gmodel for release $(RELEASE_TAG)
	cvs rtag $(RELEASE_TAG) $(PACKAGE_NAME)
